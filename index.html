<!DOCTYPE html>
<html lang="it" class="theme-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos LifeTracker</title>

    <!-- PWA Manifest and Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">

    <!-- iOS PWA Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chronos Tracker">
    <link rel="apple-touch-icon" href="logo.png">

    <!-- Favicon -->
    <link rel="icon" href="logo.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
     <style>
        :root {
            --bg-main: #030712;
            --bg-sidebar: #111827;
            --bg-card: #1f2937;
            --bg-table-header: #374151;
            --text-main: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-header: #ffffff;
            --border-color: #374151;
            --accent-color: #10b981;
            --accent-text: #ffffff;
            --accent-hover: #059669;
        }

        .theme-light {
            --bg-main: #f9fafb;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-table-header: #e5e7eb;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --text-header: #111827;
            --border-color: #e5e7eb;
            --accent-color: #10b981;
            --accent-text: #ffffff;
            --accent-hover: #059669;
        }
        
        .theme-blue {
            --bg-main: #0b1120;
            --bg-sidebar: #1c2541;
            --bg-card: #2a3858;
            --bg-table-header: #3a506b;
            --text-main: #e0e0e0;
            --text-secondary: #a7aebb;
            --text-header: #ffffff;
            --border-color: #3a506b;
            --accent-color: #62b6cb;
            --accent-text: #0b1120;
            --accent-hover: #5fa8d3;
        }


        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-main { background-color: var(--bg-main); }
        .bg-sidebar { background-color: var(--bg-sidebar); }
        .bg-card { background-color: var(--bg-card); }
        .bg-table-header { background-color: var(--bg-table-header); }
        .text-main { color: var(--text-main); }
        .text-secondary { color: var(--text-secondary); }
        .text-header { color: var(--text-header); }
        .border-color { border-color: var(--border-color); }
        .accent { background-color: var(--accent-color); color: var(--accent-text); }
        .accent-text-color { color: var(--accent-color); }
        .accent-hover:hover { background-color: var(--accent-hover); }

        .card {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .time-unit {
            background-color: #374151;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #4b5563;
        }
        .theme-light .time-unit {
            background-color: #f3f4f6;
            border-color: #e5e7eb;
        }
         .theme-blue .time-unit {
            background-color: #3a506b;
            border-color: #516d8c;
        }
        .time-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1;
        }
        #seconds-value {
            /* Adatta la dimensione del testo per evitare overflow su schermi piccoli */
            font-size: 1.8rem;
            word-break: break-all;
        }
        @media (min-width: 640px) {
            #seconds-value {
                font-size: 2.25rem;
            }
        }
        .time-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        input, select, .theme-select {
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 0.375rem;
            padding: 0.625rem;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-card); }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Sidebar styles */
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: var(--text-secondary);
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link:hover {
            background-color: var(--bg-card);
            color: var(--text-header);
        }
        .sidebar-link.active {
            background-color: var(--accent-color);
            color: var(--accent-text);
            font-weight: 600;
        }
        .view { display: none; }
        .view.active { display: block; }
        
        /* Timeline specific styles */
        .timeline-item {
            position: relative;
            padding-bottom: 2.5rem;
            padding-left: 2.5rem;
        }
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        .timeline-line {
            position: absolute;
            left: 0;
            top: 0.5rem;
            bottom: -0.5rem;
            width: 2px;
            background-color: var(--border-color);
        }
        .timeline-point {
            position: absolute;
            left: -0.4rem;
            top: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            border: 4px solid var(--bg-main);
            background-color: var(--accent-color);
        }
         .timeline-point.past {
            background-color: var(--text-secondary);
        }
    </style>
</head>
<body class="antialiased">
    <div class="relative min-h-screen md:flex">
        <!-- Overlay for mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 bg-sidebar w-72 p-4 border-r border-color flex-col space-y-4 z-40 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                    <!-- LOGO INSERITO QUI -->
                    <img src="logo.png" alt="Chronos Logo" class="h-8 w-8">
                    <h1 class="text-xl font-bold ml-2 text-header">Chronos Tracker</h1>
                </div>
                <button id="close-sidebar-btn" class="md:hidden text-secondary hover:text-header">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <!-- Navigation -->
            <nav>
                <ul class="space-y-2">
                    <li><a href="#dashboard" class="sidebar-link active" data-view="dashboard">Dashboard</a></li>
                    <li><a href="#summary" class="sidebar-link" data-view="summary">Riepilogo</a></li>
                    <li><a href="#timeline" class="sidebar-link" data-view="timeline">Timeline</a></li>
                    <li><a href="#custom-events" class="sidebar-link" data-view="custom-events">Eventi Personali</a></li>
                    <li><a href="#calculator" class="sidebar-link" data-view="calculator">Calcolatore</a></li>
                    <li><a href="#family" class="sidebar-link" data-view="family">Traguardi Famiglia</a></li>
                </ul>
            </nav>
            
            <!-- Person Management -->
            <div class="flex flex-col">
                <label for="person-select" class="text-sm font-medium text-secondary mb-2 block">Gestione Famiglia</label>
                <select id="person-select" class="w-full p-2.5 text-sm mb-2"></select>
                <button id="delete-person-btn" class="w-full text-sm bg-red-600 hover:bg-red-700 p-2 rounded-md transition-colors text-white mb-2">Elimina Selezionato</button>
                <button id="open-add-person-modal-btn" class="w-full text-sm accent accent-hover p-2 rounded-md transition-colors">Aggiungi Profilo</button>
            </div>

            <div class="pt-4 mt-auto">
                 <label for="theme-selector" class="text-sm font-medium text-secondary mb-2 block">Tema</label>
                 <select id="theme-selector" class="w-full theme-select">
                    <option value="theme-dark">Scuro</option>
                    <option value="theme-light">Chiaro</option>
                    <option value="theme-blue">Blu</option>
                 </select>
            </div>

            <footer class="text-center text-gray-500 text-xs pt-2">
                <p>© 2025 Giancarlo Tessarolo. Tutti i diritti riservati.</p>
            </footer>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 pt-16 md:p-8 overflow-y-auto bg-main">
            <button id="open-sidebar-btn" class="md:hidden fixed top-4 left-4 z-20 bg-sidebar p-2 rounded-md text-header">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
            
            <div id="no-person-view" class="text-center h-full flex flex-col justify-center items-center">
                <img src="logo.png" alt="Chronos Logo" class="h-24 w-24 mb-6">
                <h2 class="text-3xl font-bold text-header mb-4">Benvenuto!</h2>
                <p class="text-secondary mb-6 max-w-md">Per iniziare, aggiungi il primo membro della tua famiglia usando il pulsante "Aggiungi Profilo".</p>
            </div>
            
            <div id="main-content-views" class="hidden">
                 <div id="dashboard" class="view active space-y-8">
                    <section class="card bg-card">
                        <h2 class="text-2xl font-bold mb-4 accent-text-color">Età di <span class="active-person-name"></span></h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4" id="age-display"></div>
                         <div class="grid grid-cols-1 mt-4"><div class="time-unit"><div id="seconds-value" class="time-value">0</div><div class="time-label">SECONDI TOTALI</div></div></div>
                    </section>

                    <section class="card bg-card">
                        <h2 class="text-2xl font-bold mb-4 accent-text-color">Prossimo Grande Traguardo</h2>
                        <div id="next-milestone-countdown-container" class="text-center">
                            <p id="next-milestone-name" class="text-xl font-semibold text-main mb-4">Caricamento...</p>
                            <div id="countdown-display" class="grid grid-cols-4 gap-2 md:gap-4">
                                <!-- Countdown units will be injected here -->
                            </div>
                        </div>
                    </section>

                    <section class="card bg-card">
                        <h2 class="text-2xl font-bold mb-4 accent-text-color">La tua Vita in Numeri</h2>
                        <div id="life-in-numbers-display" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </section>
                </div>
                <div id="summary" class="view"><section class="card bg-card"><h2 class="text-2xl font-bold mb-4 accent-text-color">Riepilogo per <span class="active-person-name"></span></h2><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-table-header"><tr><th class="p-3">Unità di Misura</th><th class="p-3">Valore Totale</th></tr></thead><tbody id="summary-table-body"></tbody></table></div></section></div>
                <div id="timeline" class="view"><section class="card bg-card"><h2 class="text-2xl font-bold mb-4 accent-text-color">Timeline di <span class="active-person-name"></span></h2><div id="timeline-container" class="relative"></div></section></div>
                <div id="custom-events" class="view"><section class="card bg-card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold accent-text-color">Eventi Personali di <span class="active-person-name"></span></h2><button id="open-add-event-modal-btn" class="text-sm accent accent-hover p-2 px-4 rounded-md transition-colors">Aggiungi Evento</button></div><ul id="custom-events-list" class="space-y-3"></ul></section></div>
                <div id="calculator" class="view"><section class="card bg-card"><h2 class="text-2xl font-bold mb-4 accent-text-color">Calcolatore Traguardi</h2><p class="text-secondary mb-4">Scopri quando <span class="active-person-name"></span> raggiungerà un traguardo.</p><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div><label class="block mb-2 text-sm font-medium">Unità</label><select id="milestone-unit" class="w-full"><option value="seconds">Secondi</option><option value="minutes">Minuti</option><option value="hours">Ore</option><option value="days">Giorni</option><option value="weeks">Settimane</option><option value="months">Mesi</option><option value="years">Anni</option></select></div><div><label class="block mb-2 text-sm font-medium">Traguardo</label><input type="number" id="milestone-target" placeholder="es. 10000" class="w-full"></div><div class="text-center text-secondary text-sm">Attuale: <span id="current-milestone-value" class="font-bold text-main">0</span></div></div><div id="milestone-result-container" class="mt-6 text-center p-4 bg-main rounded-lg hidden"><p class="text-lg">Data del traguardo:</p><p id="milestone-result-date" class="text-2xl font-bold accent-text-color mt-1"></p><div id="calendar-link-wrapper" class="mt-4"></div></div></section></div>
                <div id="family" class="view"><section class="card bg-card"><h2 class="text-2xl font-bold mb-4 accent-text-color">Traguardi Familiari</h2><p class="text-secondary mb-4">I prossimi 10 traguardi più vicini per tutti i membri.</p><ul id="family-milestones-list" class="space-y-3"></ul></section></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-person-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center"><div class="card bg-sidebar w-full max-w-md m-4"><h2 class="text-xl font-bold text-header mb-4">Aggiungi Profilo</h2><div class="space-y-4"><input type="text" id="modal-new-person-name" placeholder="Nome" class="w-full text-sm"><div><label class="text-sm text-secondary">Data di nascita</label><input type="date" id="modal-birthdate" class="w-full text-sm"></div><div><label class="text-sm text-secondary">Ora di nascita</label><input type="time" id="modal-birthtime" class="w-full text-sm"></div><div class="flex justify-end space-x-3 pt-2"><button id="modal-cancel-btn" class="text-sm bg-gray-600 hover:bg-gray-700 p-2 px-4 rounded-md transition-colors text-white">Annulla</button><button id="modal-add-btn" class="text-sm accent accent-hover p-2 px-4 rounded-md transition-colors">Salva</button></div></div></div></div>
    <div id="add-event-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center"><div class="card bg-sidebar w-full max-w-md m-4"><h2 class="text-xl font-bold text-header mb-4">Aggiungi Evento Personale</h2><div class="space-y-4"><input type="text" id="modal-event-name" placeholder="Nome evento (es. Laurea)" class="w-full text-sm"><div><label class="text-sm text-secondary">Data evento</label><input type="date" id="modal-event-date" class="w-full text-sm"></div><div><label class="text-sm text-secondary">Ora evento</label><input type="time" id="modal-event-time" class="w-full text-sm" value="00:00"></div><div class="flex justify-end space-x-3 pt-2"><button id="modal-event-cancel-btn" class="text-sm bg-gray-600 hover:bg-gray-700 p-2 px-4 rounded-md transition-colors text-white">Annulla</button><button id="modal-event-add-btn" class="text-sm accent accent-hover p-2 px-4 rounded-md transition-colors">Salva Evento</button></div></div></div></div>
    <div id="timeline-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center"><div class="card bg-sidebar w-full max-w-md m-4"><h2 id="modal-timeline-event-name" class="text-xl font-bold text-header mb-2">Nome Evento</h2><p id="modal-timeline-event-date" class="text-sm text-secondary mb-4">Data Evento</p><div class="bg-main p-4 rounded-lg"><p class="text-sm text-secondary">All'epoca di questo evento, <span class="active-person-name"></span> aveva:</p><p id="modal-timeline-age-at-event" class="text-lg font-bold text-main mt-1"></p></div><div class="flex justify-end pt-4"><button id="modal-timeline-close-btn" class="text-sm accent accent-hover p-2 px-4 rounded-md transition-colors">Chiudi</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js').then(registration => {
                        console.log('Service Worker registrato con successo:', registration);
                    }).catch(registrationError => {
                        console.log('Registrazione Service Worker fallita:', registrationError);
                    });
                });
            }

            // DOM Elements
            const personSelect = document.getElementById('person-select');
            const deletePersonBtn = document.getElementById('delete-person-btn');
            const mainContentViews = document.getElementById('main-content-views');
            const noPersonView = document.getElementById('no-person-view');
            const activePersonNameSpans = document.querySelectorAll('.active-person-name');
            
            // Views & Lists
            const summaryTableBody = document.getElementById('summary-table-body');
            const familyMilestonesList = document.getElementById('family-milestones-list');
            const customEventsList = document.getElementById('custom-events-list');
            const timelineContainer = document.getElementById('timeline-container');
            
            // Modals
            const addPersonModal = document.getElementById('add-person-modal');
            const openAddPersonModalBtn = document.getElementById('open-add-person-modal-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalAddBtn = document.getElementById('modal-add-btn');
            const addEventModal = document.getElementById('add-event-modal');
            const openAddEventModalBtn = document.getElementById('open-add-event-modal-btn');
            const modalEventCancelBtn = document.getElementById('modal-event-cancel-btn');
            const modalEventAddBtn = document.getElementById('modal-event-add-btn');
            const timelineDetailModal = document.getElementById('timeline-detail-modal');
            const modalTimelineCloseBtn = document.getElementById('modal-timeline-close-btn');

            // Calculator
            const milestoneUnit = document.getElementById('milestone-unit');
            const milestoneTarget = document.getElementById('milestone-target');
            const milestoneResultContainer = document.getElementById('milestone-result-container');
            const milestoneResultDate = document.getElementById('milestone-result-date');
            const calendarLinkWrapper = document.getElementById('calendar-link-wrapper');

            // Responsive sidebar
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const openSidebarBtn = document.getElementById('open-sidebar-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            
            // Theme selector
            const themeSelector = document.getElementById('theme-selector');

            // State
            let people = [];
            let activePersonId = null;
            let timerInterval = null;

            // --- Theme Management ---
            const applyTheme = (theme) => {
                document.documentElement.className = theme;
                localStorage.setItem('chronosTheme', theme);
                themeSelector.value = theme;
            };
            const loadTheme = () => applyTheme(localStorage.getItem('chronosTheme') || 'theme-dark');
            themeSelector.addEventListener('change', () => applyTheme(themeSelector.value));

            // --- Person & Event Management ---
            const loadPeople = () => {
                people = JSON.parse(localStorage.getItem('chronosPeople')) || [];
                activePersonId = localStorage.getItem('chronosActivePersonId');
                if ((activePersonId && !people.find(p => p.id == activePersonId)) || (!activePersonId && people.length > 0)) {
                    activePersonId = people.length > 0 ? people[0].id : null;
                }
            };
            
            const savePeople = () => {
                localStorage.setItem('chronosPeople', JSON.stringify(people));
                localStorage.setItem('chronosActivePersonId', activePersonId);
            };

            const getActivePerson = () => people.find(p => p.id == activePersonId);

            modalAddBtn.addEventListener('click', () => {
                const name = document.getElementById('modal-new-person-name').value.trim();
                const birthDate = document.getElementById('modal-birthdate').value;
                const birthTime = document.getElementById('modal-birthtime').value;
                if (!name || !birthDate || !birthTime) {
                    alert("Per favore, compila tutti i campi."); return;
                }
                const newPerson = { id: Date.now(), name, birthDate, birthTime, customEvents: [] };
                people.push(newPerson);
                activePersonId = newPerson.id;
                savePeople();
                renderPersonSelector();
                startTimerForActivePerson();
                document.getElementById('modal-new-person-name').value = '';
                addPersonModal.classList.replace('flex', 'hidden');
            });

            deletePersonBtn.addEventListener('click', () => {
                if (!activePersonId) return;
                const person = getActivePerson();
                if (person && confirm(`Sei sicuro di voler eliminare il profilo di ${person.name}?`)) {
                    people = people.filter(p => p.id != activePersonId);
                    activePersonId = people.length > 0 ? people[0].id : null;
                    savePeople();
                    renderPersonSelector();
                    startTimerForActivePerson();
                }
            });

            modalEventAddBtn.addEventListener('click', () => {
                const person = getActivePerson();
                if (!person) return;
                const name = document.getElementById('modal-event-name').value.trim();
                const date = document.getElementById('modal-event-date').value;
                const time = document.getElementById('modal-event-time').value;
                if (!name || !date || !time) {
                    alert("Per favore, compila tutti i campi dell'evento."); return;
                }
                person.customEvents = person.customEvents || [];
                person.customEvents.push({ id: Date.now(), name, date, time });
                savePeople();
                updateUI(new Date(person.birthDate + 'T' + person.birthTime));
                addEventModal.classList.replace('flex', 'hidden');
                document.getElementById('modal-event-name').value = '';
            });

            customEventsList.addEventListener('click', e => {
                if (e.target.classList.contains('delete-event-btn')) {
                    const eventId = e.target.dataset.id;
                    const person = getActivePerson();
                    if (person && confirm('Sei sicuro di voler eliminare questo evento?')) {
                        person.customEvents = person.customEvents.filter(event => event.id != eventId);
                        savePeople();
                        updateUI(new Date(person.birthDate + 'T' + person.birthTime));
                    }
                }
            });

            // --- UI Rendering ---
            const renderPersonSelector = () => {
                personSelect.innerHTML = people.map(p => `<option value="${p.id}" ${p.id == activePersonId ? 'selected' : ''}>${p.name}</option>`).join('');
                toggleMainView();
            };

            const toggleMainView = () => {
                const hasPeople = people.length > 0;
                noPersonView.classList.toggle('hidden', hasPeople);
                mainContentViews.classList.toggle('hidden', !hasPeople);
                if (!hasPeople && timerInterval) clearInterval(timerInterval);
            };

            // --- Core Logic & Updates ---
            const startTimerForActivePerson = () => {
                if (timerInterval) clearInterval(timerInterval);
                const person = getActivePerson();
                if (!person) { toggleMainView(); return; }
                
                activePersonNameSpans.forEach(span => span.textContent = person.name);
                const birthDateTime = new Date(`${person.birthDate}T${person.birthTime}`);
                if (isNaN(birthDateTime.getTime())) return;
                
                const updateAll = () => updateUI(birthDateTime);
                updateAll();
                timerInterval = setInterval(updateAll, 1000);
            };

            const updateUI = (birthDateTime) => {
                const now = new Date();
                const person = getActivePerson();
                if (!person) return;
                updateLiveAge(now, birthDateTime);
                updateLifeInNumbers(now, birthDateTime);
                updateNextMilestoneCountdown(now, birthDateTime);
                updateSummaryTable(now, birthDateTime);
                updateFamilyMilestones(now);
                updateCustomEventsList(now, person);
                updateTimeline(now, person);
                updateCurrentMilestoneValue(now, birthDateTime);
            };
            
            const formatDiff = (ms) => {
                const totalSeconds = Math.floor(ms / 1000);
                const days = Math.floor(totalSeconds / 86400);
                const hours = Math.floor((totalSeconds % 86400) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                return `${days}g ${hours}h ${minutes}m`;
            }

            const updateLiveAge = (now, birthDateTime) => {
                let tempDate = new Date(birthDateTime);
                let years = now.getFullYear() - birthDateTime.getFullYear();
                let months = now.getMonth() - birthDateTime.getMonth();
                let days = now.getDate() - birthDateTime.getDate();
                let hours = now.getHours() - birthDateTime.getHours();
                let minutes = now.getMinutes() - birthDateTime.getMinutes();
                let seconds = now.getSeconds() - birthDateTime.getSeconds();

                if (seconds < 0) { minutes--; seconds += 60; }
                if (minutes < 0) { hours--; minutes += 60; }
                if (hours < 0) { days--; hours += 24; }
                if (days < 0) {
                    months--;
                    const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                    days += prevMonth.getDate();
                }
                if (months < 0) { years--; months += 12; }

                document.getElementById('age-display').innerHTML = [
                    { value: years, label: 'ANNI' }, { value: months, label: 'MESI' }, { value: days, label: 'GIORNI' },
                    { value: hours, label: 'ORE' }, { value: minutes, label: 'MINUTI' }, { value: seconds, label: 'SECONDI' }
                ].map(u => `<div class="time-unit"><div class="time-value">${String(u.value).padStart(2, '0')}</div><div class="time-label">${u.label}</div></div>`).join('');
                document.getElementById('seconds-value').textContent = Math.floor((now - birthDateTime) / 1000).toLocaleString('it-IT');
            };
            
            const updateCustomEventsList = (now, person) => {
                if (!person || !person.customEvents) { customEventsList.innerHTML = ''; return; }
                customEventsList.innerHTML = person.customEvents
                    .sort((a,b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time))
                    .map(event => {
                        const eventDate = new Date(`${event.date}T${event.time}`);
                        const diff = now - eventDate;
                        const formattedDiff = diff > 0 ? formatDiff(diff) + ' fa' : 'Futuro';
                        return `<li class="p-3 bg-card rounded-lg flex justify-between items-center border border-color"><div class="pr-2"><p class="font-bold text-lg accent-text-color">${event.name}</p><p class="text-sm text-secondary">${eventDate.toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' })} - ${formattedDiff}</p></div><button data-id="${event.id}" class="delete-event-btn text-red-500 hover:text-red-400 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></li>`;
                    }).join('');
            };

            // --- Milestone Calculation (Revised Logic) ---

            const findNextRoundNumber = (currentValue) => {
                if (currentValue < 1) return 1;
                const strValue = Math.floor(currentValue).toString();
                const magnitude = Math.pow(10, strValue.length - 1);
                const base = currentValue / magnitude;

                const steps = [1.1, 1.2, 1.25, 1.3, 1.4, 1.5, 1.6, 1.7, 1.75, 1.8, 1.9, 2, 2.5, 3, 4, 5, 6, 7, 7.5, 8, 9, 10];
                
                for (const step of steps) {
                    if (step > base) {
                        const result = step * magnitude;
                        return magnitude > 1000 ? Math.round(result) : result;
                    }
                }
                return 10 * magnitude;
            };

            const findPreviousRoundNumber = (currentValue) => {
                if (currentValue < 1) return 0;
                const strValue = Math.floor(currentValue).toString();
                const magnitude = Math.pow(10, strValue.length - 1);
                const base = currentValue / magnitude;
                
                const steps = [10, 9, 8, 7.5, 7, 6, 5, 4, 3, 2.5, 2, 1.9, 1.8, 1.75, 1.7, 1.6, 1.5, 1.4, 1.3, 1.25, 1.2, 1.1, 1];

                for (const step of steps) {
                    if (step < base) {
                        const result = step * magnitude;
                        return magnitude > 1000 ? Math.round(result) : result;
                    }
                }
                if (magnitude > 1) return 9 * (magnitude / 10);
                return 0;
            };

            const calculateDateForMilestone = (target, unit, birthDateTime) => {
                let resultDate;
                if (unit === 'years') {
                    resultDate = new Date(birthDateTime);
                    resultDate.setFullYear(birthDateTime.getFullYear() + Math.ceil(target));
                } else if (unit === 'months') {
                    resultDate = new Date(birthDateTime);
                    resultDate.setMonth(birthDateTime.getMonth() + Math.ceil(target));
                } else {
                    const msPerUnit = { seconds: 1000, minutes: 60000, hours: 3600000, days: 86400000, weeks: 604800000 }[unit];
                    if (!msPerUnit) return null;
                    resultDate = new Date(birthDateTime.getTime() + target * msPerUnit);
                }
                return resultDate;
            };

            const getAllMilestonesForPerson = (now, person) => {
                const birthDateTime = new Date(`${person.birthDate}T${person.birthTime}`);
                const units = [
                    { name: 'seconds', label: 'secondi' }, { name: 'minutes', label: 'minuti' },
                    { name: 'hours', label: 'ore' }, { name: 'days', label: 'giorni' },
                    { name: 'weeks', label: 'settimane' }, { name: 'months', label: 'mesi' },
                    { name: 'years', label: 'anni' }
                ];
                const allMilestones = [];
                units.forEach(unitInfo => {
                    let currentValue = getTotalValueInUnit(now, birthDateTime, unitInfo.name);
                    if (currentValue < 0) return;
                    
                    let nextValue = currentValue;
                    for (let i = 0; i < 3; i++) {
                        nextValue = findNextRoundNumber(nextValue);
                        const date = calculateDateForMilestone(nextValue, unitInfo.name, birthDateTime);
                        if (date) allMilestones.push({ value: nextValue, unit: unitInfo.label, date, person });
                    }
                    
                    let prevValue = findPreviousRoundNumber(currentValue);
                    if (prevValue > 0) {
                        const date = calculateDateForMilestone(prevValue, unitInfo.name, birthDateTime);
                        if (date) allMilestones.push({ value: prevValue, unit: unitInfo.label, date, person });
                    }
                });
                return [...new Map(allMilestones.map(m => [`${m.value}-${m.unit}`, m])).values()];
            };

            const calculateAgeAtDate = (birthDateTime, eventDate) => {
                let years = eventDate.getFullYear() - birthDateTime.getFullYear();
                let months = eventDate.getMonth() - birthDateTime.getMonth();
                let days = eventDate.getDate() - birthDateTime.getDate();
                
                if (days < 0) {
                    months--;
                    const prevMonth = new Date(eventDate.getFullYear(), eventDate.getMonth(), 0);
                    days += prevMonth.getDate();
                }
                if (months < 0) {
                    years--;
                    months += 12;
                }
                return `${years} anni, ${months} mesi e ${days} giorni`;
            };

            const updateTimeline = (now, person) => {
                if (!person) return;
                const customEvents = (person.customEvents || []).map(e => ({
                    date: new Date(`${e.date}T${e.time}`),
                    text: e.name,
                    type: 'custom'
                }));
                const milestones = getAllMilestonesForPerson(now, person)
                    .map(m => ({ ...m, text: `${m.value.toLocaleString('it-IT')} ${m.unit}` }));
                const allEvents = [...customEvents, ...milestones].sort((a, b) => a.date - b.date);
                timelineContainer.innerHTML = allEvents.map(event => {
                    if (!event.date || isNaN(event.date.getTime())) return '';
                    const isPast = event.date < now;
                    const formattedDate = new Intl.DateTimeFormat('it-IT', { day: '2-digit', month: 'long', year: 'numeric' }).format(event.date);
                    const eventDateISO = event.date.toISOString();
                    return `<div class="timeline-item clickable-timeline-item" data-event-name="${event.text.replace(/"/g, '&quot;')}" data-event-date="${eventDateISO}" style="cursor: pointer;">
                                <div class="timeline-line" style="left: 0.05rem;"></div>
                                <div class="timeline-point ${isPast ? 'past' : ''}"></div>
                                <p class="font-bold text-main pointer-events-none">${event.text}</p>
                                <p class="text-sm text-secondary pointer-events-none">${formattedDate}</p>
                            </div>`;
                }).join('');
            };
            
            const getTotalValueInUnit = (now, birthDateTime, unit) => {
                const diff = now.getTime() - birthDateTime.getTime();
                switch (unit) {
                    case 'seconds': return diff / 1000;
                    case 'minutes': return diff / 60000;
                    case 'hours': return diff / 3600000;
                    case 'days': return diff / 86400000;
                    case 'weeks': return diff / 604800000;
                    case 'months': return (now.getFullYear() - birthDateTime.getFullYear()) * 12 + (now.getMonth() - birthDateTime.getMonth());
                    case 'years': return diff / 31557600000;
                    default: return 0;
                }
            };
            
            const renderMilestoneLi = (milestone, person, isFamily = false) => {
                const title = `Traguardo di ${person.name}: ${milestone.value.toLocaleString('it-IT')} ${milestone.unit}`;
                const description = `Il giorno in cui ${person.name} raggiungerà ${milestone.value.toLocaleString('it-IT')} ${milestone.unit} di vita.`;
                const calendarHref = generateCalendarLink(title, milestone.date, description);
                const formatter = new Intl.DateTimeFormat('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
                
                const saveButton = milestone.date > new Date() 
                    ? `<a href="${calendarHref}" target="_blank" rel="noopener noreferrer" class="text-sm accent accent-hover p-2 rounded-md transition-colors">Salva</a>` 
                    : '';

                return `<li class="p-3 bg-main rounded-lg flex justify-between items-center border border-color"><div class="pr-2"><p class="font-bold text-lg accent-text-color">${milestone.value.toLocaleString('it-IT')} ${milestone.unit} ${isFamily ? `<span class="text-sm font-medium text-main"> - ${person.name}</span>` : ''}</p><p class="text-sm text-secondary">${formatter.format(milestone.date)}</p></div><div>${saveButton}</div></li>`;
            };

            const generateCalendarLink = (title, date, description) => {
                const formatDateForGoogle = (d) => d.toISOString().replace(/-|:|\.\d+/g, '');
                const startDate = formatDateForGoogle(date);
                const endDate = formatDateForGoogle(new Date(date.getTime() + 60 * 60 * 1000));
                return `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(description)}`;
            };
            
            const updateSummaryTable = (now, birthDateTime) => {
                const units = ['years', 'months', 'weeks', 'days', 'hours', 'minutes', 'seconds'];
                const labels = {'years': 'Anni', 'months': 'Mesi', 'weeks': 'Settimane', 'days': 'Giorni', 'hours': 'Ore', 'minutes': 'Minuti', 'seconds': 'Secondi'};
                summaryTableBody.innerHTML = units.map(unit => `<tr class="border-b border-color"><td class="p-3 font-medium">${labels[unit]}</td><td class="p-3 accent-text-color font-mono">${Math.floor(getTotalValueInUnit(now, birthDateTime, unit)).toLocaleString('it-IT')}</td></tr>`).join('');
            };

            const getZodiacSign = (date) => {
                const day = date.getDate();
                const month = date.getMonth() + 1;
                if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return "Acquario";
                if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return "Pesci";
                if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return "Ariete";
                if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return "Toro";
                if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return "Gemelli";
                if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return "Cancro";
                if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return "Leone";
                if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return "Vergine";
                if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return "Bilancia";
                if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return "Scorpione";
                if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return "Sagittario";
                return "Capricorno";
            };

            const getGeneration = (birthYear) => {
                if (birthYear >= 1997 && birthYear <= 2012) return "Gen Z";
                if (birthYear >= 1981 && birthYear <= 1996) return "Millennial";
                if (birthYear >= 1965 && birthYear <= 1980) return "Gen X";
                if (birthYear >= 1946 && birthYear <= 1964) return "Baby Boomer";
                if (birthYear >= 1928 && birthYear <= 1945) return "Silent Gen";
                return "Anziana";
            };

            const updateLifeInNumbers = (now, birthDateTime) => {
                const lifeInNumbersDisplay = document.getElementById('life-in-numbers-display');
                const daysLived = getTotalValueInUnit(now, birthDateTime, 'days');
                if (daysLived <= 0) {
                    lifeInNumbersDisplay.innerHTML = '';
                    return;
                }
                const yearsSlept = (daysLived / 3) / 365.25;
                const sunrises = Math.floor(daysLived);
                const zodiacSign = getZodiacSign(birthDateTime);
                const generation = getGeneration(birthDateTime.getFullYear());

                lifeInNumbersDisplay.innerHTML = `
                    <div class="time-unit"><div class="time-value">${yearsSlept.toFixed(1)}</div><div class="time-label">ANNI DORMENDO</div></div>
                    <div class="time-unit"><div class="time-value">${sunrises.toLocaleString('it-IT')}</div><div class="time-label">ALBE VISTE</div></div>
                    <div class="time-unit"><div class="time-value" style="font-size: 1.5rem; padding-top: 0.5rem;">${zodiacSign}</div><div class="time-label">SEGNO ZODIACALE</div></div>
                    <div class="time-unit"><div class="time-value" style="font-size: 1.5rem; padding-top: 0.5rem;">${generation}</div><div class="time-label">GENERAZIONE</div></div>
                `;
            };

            const updateNextMilestoneCountdown = (now, birthDateTime) => {
                const person = getActivePerson();
                if (!person) return;
                const nameEl = document.getElementById('next-milestone-name');
                const displayEl = document.getElementById('countdown-display');

                const upcoming = getAllMilestonesForPerson(now, person)
                    .filter(m => m.date > now)
                    .sort((a, b) => a.date - b.date);

                if (upcoming.length === 0) {
                    nameEl.textContent = "Nessun traguardo imminente trovato.";
                    displayEl.innerHTML = "";
                    return;
                }

                const nextMilestone = upcoming[0];
                nameEl.textContent = `${nextMilestone.value.toLocaleString('it-IT')} ${nextMilestone.unit}`;
                
                const diff = nextMilestone.date.getTime() - now.getTime();
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                displayEl.innerHTML = `
                    <div class="time-unit"><div class="time-value">${String(days).padStart(2, '0')}</div><div class="time-label">GIORNI</div></div>
                    <div class="time-unit"><div class="time-value">${String(hours).padStart(2, '0')}</div><div class="time-label">ORE</div></div>
                    <div class="time-unit"><div class="time-value">${String(minutes).padStart(2, '0')}</div><div class="time-label">MINUTI</div></div>
                    <div class="time-unit"><div class="time-value">${String(seconds).padStart(2, '0')}</div><div class="time-label">SECONDI</div></div>
                `;
            };

            const updateFamilyMilestones = (now) => {
                if (people.length === 0) return;
                let allMilestones = [];
                people.forEach(person => {
                    const personMilestones = getAllMilestonesForPerson(now, person)
                        .filter(m => m.date > now);
                    allMilestones.push(...personMilestones);
                });
                
                const uniqueMilestones = [...new Map(allMilestones.map(item => [`${item.value}-${item.unit}-${item.person.id}`, item])).values()];
                uniqueMilestones.sort((a, b) => a.date - b.date);
                familyMilestonesList.innerHTML = uniqueMilestones.slice(0, 10).map(m => renderMilestoneLi(m, m.person, true)).join('');
            };
            
            const calculateAndDisplayMilestone = () => {
                const person = getActivePerson();
                if (!person) return;

                const birthDateTime = new Date(`${person.birthDate}T${person.birthTime}`);
                const unit = milestoneUnit.value;
                const target = parseFloat(milestoneTarget.value);

                if (isNaN(target) || target <= 0) {
                    milestoneResultContainer.classList.add('hidden');
                    return;
                }

                const resultDate = calculateDateForMilestone(target, unit, birthDateTime);
                if(!resultDate) return;
                
                milestoneResultDate.textContent = resultDate.toLocaleString('it-IT', { dateStyle: 'full', timeStyle: 'medium' });

                const calendarTitle = `Raggiungere ${target.toLocaleString('it-IT')} ${unit} di vita`;
                const calendarDescription = `Un traguardo speciale per ${person.name}.`;
                const calendarLink = generateCalendarLink(calendarTitle, resultDate, calendarDescription);

                if (resultDate > new Date()) {
                    calendarLinkWrapper.innerHTML = `<a href="${calendarLink}" target="_blank" rel="noopener noreferrer" class="text-sm accent accent-hover p-2 px-4 rounded-md transition-colors">Aggiungi al Calendario</a>`;
                } else {
                    calendarLinkWrapper.innerHTML = `<p class="text-sm text-secondary">(Traguardo già raggiunto)</p>`;
                }
                
                milestoneResultContainer.classList.remove('hidden');
            };

            const updateCurrentMilestoneValue = (now, birthDateTime) => { 
                const unit = document.getElementById('milestone-unit').value; 
                document.getElementById('current-milestone-value').textContent = Math.floor(getTotalValueInUnit(now, birthDateTime, unit)).toLocaleString('it-IT'); 
                calculateAndDisplayMilestone();
            };

            milestoneUnit.addEventListener('change', () => {
                 const person = getActivePerson();
                 if(person) updateCurrentMilestoneValue(new Date(), new Date(`${person.birthDate}T${person.birthTime}`));
            });
            milestoneTarget.addEventListener('input', calculateAndDisplayMilestone);


            // --- Init and Event Listeners ---
            const init = () => {
                loadTheme();
                loadPeople();
                renderPersonSelector();
                startTimerForActivePerson();
                setupNavigation();
                
                const setupModal = (openBtn, modal, cancelBtn) => {
                    openBtn.addEventListener('click', () => modal.classList.replace('hidden', 'flex'));
                    cancelBtn.addEventListener('click', () => modal.classList.replace('flex', 'hidden'));
                    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.replace('flex', 'hidden'); });
                };
                setupModal(openAddPersonModalBtn, addPersonModal, modalCancelBtn);
                setupModal(openAddEventModalBtn, addEventModal, modalEventCancelBtn);
                
                personSelect.addEventListener('change', () => {
                    activePersonId = personSelect.value;
                    savePeople();
                    startTimerForActivePerson();
                });

                timelineContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('clickable-timeline-item')) {
                        const person = getActivePerson();
                        if (!person) return;

                        const birthDateTime = new Date(`${person.birthDate}T${person.birthTime}`);
                        const eventName = e.target.dataset.eventName;
                        const eventDate = new Date(e.target.dataset.eventDate);

                        document.getElementById('modal-timeline-event-name').textContent = eventName;
                        document.getElementById('modal-timeline-event-date').textContent = new Intl.DateTimeFormat('it-IT', { dateStyle: 'full' }).format(eventDate);
                        document.getElementById('modal-timeline-age-at-event').textContent = calculateAgeAtDate(birthDateTime, eventDate);

                        timelineDetailModal.classList.replace('hidden', 'flex');
                    }
                });

                modalTimelineCloseBtn.addEventListener('click', () => timelineDetailModal.classList.replace('flex', 'hidden'));
                timelineDetailModal.addEventListener('click', e => { if (e.target === timelineDetailModal) timelineDetailModal.classList.replace('flex', 'hidden'); });
            };

            const setupNavigation = () => {
                const links = document.querySelectorAll('.sidebar-link');
                const views = document.querySelectorAll('.view');
                links.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const viewId = link.getAttribute('data-view');
                        views.forEach(view => view.classList.remove('active'));
                        document.getElementById(viewId).classList.add('active');
                        links.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        if (window.innerWidth < 768) closeSidebar();
                    });
                });
            };

            const openSidebar = () => { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); };
            const closeSidebar = () => { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); };
            openSidebarBtn.addEventListener('click', openSidebar);
            closeSidebarBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);

            init();
        });
    </script>
</body>
</html>

